<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Semicolon | video request</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
    />
  </head>
  <body>
    <noscript>
      <div style="background-color: rgb(128, 13, 13); color: #fff; width: 100%; text-align: center; position:fixed; top:0; z-index: 500">
        <h3>
          JavaScript is not enabled! <a href="https://enable-javascript.com/">Checkout this link</a> to learn more.
        </h3>
      </div>
    </noscript>
    <div class="container my-5">      
      <div class="formContainer my-5">
        <form id="createForm" method="POST">
          <div class="row">
            <div class="col-md">
              <div class="form-group">
                <label for="author_name">Your name *</label>
                <input
                  class="form-control"
                  name="author_name"
                  placeholder="Write your name here"
                  required
                />
              </div>
            </div>
            <div class="col-md">
              <div class="form-group">
                <label for="author_email">Your email *</label>
                <input
                  class="form-control"
                  name="author_email"
                  placeholder="Write your email here"
                  required
                />
              </div>
            </div>
          </div>
          <hr />
          <div class="row">
            <div class="col-md">
              <div class="form-group">
                <label for="topic_title">Topic *</label>
                <input
                  class="form-control"
                  name="topic_title"
                  placeholder="Write your suggested topic here"
                  required
                />
              </div>
            </div>
            <div class="col-md">
              <div class="form-group">
                <label for="target_level">Target level</label>
                <select
                  class="form-control"
                  name="target_level"
                  placeholder="Write your name here"
                >
                  <option value="begineer">Beginner</option>
                  <option value="medium">Medium</option>
                  <option value="advanced">Advanced</option>
                </select>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md">
              <div class="form-group">
                <label for="topic_details">More details *</label>
                <textarea
                  class="form-control"
                  name="topic_details"
                  placeholder="Write your topic in more details here"
                  required
                ></textarea>
              </div>
            </div>
            <div class="col-md">
              <div class="form-group">
                <label for="expected_result">Expected results</label>
                <textarea
                  class="form-control"
                  name="expected_result"
                  placeholder="Write what do you expect after watching this video"
                ></textarea>
              </div>
            </div>
          </div>

          <button type="submit" class="btn btn-success mt-3">
            Send video request
          </button>
        </form>
      </div>
      <hr />
      <h1 class="mb-4">List of requested videos</h1>
      <div id="listOfRequests">
        <!--
        <div class="card mb-3">
          <div class="card-body d-flex justify-content-between flex-row">
            <div class="d-flex flex-column">
              <h3>{{title}}</h3>
              <p class="text-muted mb-2">{{details}}</p>
              <p class="mb-0 text-muted">
                <strong>Expected results:</strong> {{expected}}
              </p>
            </div>
            <div class="d-flex flex-column text-center">
              <a class="btn btn-link">ðŸ”º</a>
              <h3>0</h3>
              <a class="btn btn-link">ðŸ”»</a>
            </div>
          </div>
          <div class="card-footer d-flex flex-row justify-content-between">
            <div>
              <span class="text-info">{{state}}</span>
              &bullet; added by <strong>{{name}}</strong> on
              <strong>{{dated}}</strong>
            </div>
            <div
              class="d-flex justify-content-center flex-column 408ml-auto mr-2"
            >
              <div class="badge badge-success">
                {{level}}
              </div>
            </div>
          </div>
        </div>
      -->
      </div>
    </div>    
    <script>
      tpl = `<div class="card mb-3">
          <div class="card-body d-flex justify-content-between flex-row">
            <div class="d-flex flex-column">
              <h3>{{title}}</h3>
              <p class="text-muted mb-2">{{details}}</p>
              <p class="mb-0 text-muted">
                <strong>Expected results:</strong> {{expected}}
              </p>
            </div>
            <div class="d-flex flex-column text-center">
              <a class="btn btn-link">ðŸ”º</a>
              <h3>0</h3>
              <a class="btn btn-link">ðŸ”»</a>
            </div>
          </div>
          <div class="card-footer d-flex flex-row justify-content-between">
            <div>
              <span class="text-info">{{state}}</span>
              &bullet; added by <strong>{{name}}</strong> on
              <strong>{{dated}}</strong>
            </div>
            <div
              class="d-flex justify-content-center flex-column 408ml-auto mr-2"
            >
              <div class="badge badge-success">
                {{level}}
              </div>
            </div>
          </div>
        </div>`;
      var res = {}
      

      function render_tpl(tpl, res) {
          var output = tpl
          var tpl_inst = {
        title: res.topic_title,
        details: res.topic_details,
        expected: res.expected_result,
        state: res.status,
        name: res.author_name,
        email: res.author_email,
        dated: res.submit_date,
        level: res.target_level
      }
          Object.keys(tpl_inst).forEach((k) => {
            var replace = "{{" + k + "}}";
            var re = new RegExp(replace, "g");
            output = output.replace(re, tpl_inst[k])
          })
          return output
        }

        function loadVideos(){
          if (readVideos.readyState === XMLHttpRequest.DONE) {
          if (readVideos.status === 200) {
            var response = JSON.parse(readVideos.responseText);
            var listOfRequests = document.getElementById('listOfRequests');
            //response.f
            var i = 0;
            for (var res of response){
              console.log(i)
              i++
              console.log(render_tpl(tpl, res))
              listOfRequests.insertAdjacentHTML('beforeend', render_tpl(tpl, res));
             // item = document.createElement = render_tpl(tpl,tpl_inst)
              //listOfRequests.appendChild(item);
            }
          } else {
            alert('There was a problem with the request.');
          }
        }
          
          
        }

      function checkSaving() {
        if (xhr.readyState === XMLHttpRequest.DONE) {
          if (xhr.status === 200) {
            var response = JSON.parse(xhr.responseText);
            alert('New video request has been created with an ID:\n'+response._id);
            formElements = createForm.elements
            for (i = 0; i < formElements.length; i++){
              formElements[i].value = '';
            }
            var listOfRequests = document.getElementById('listOfRequests');
            listOfRequests.insertAdjacentHTML('afterbegin', render_tpl(tpl, response));
          } else {
            alert('There was a problem with the request.');
          }
        }
      }
      document.addEventListener('DOMContentLoaded', function(){
        readVideos = new XMLHttpRequest();
        readVideos.onreadystatechange = loadVideos;
        readVideos.open("GET",'http://localhost:7777/video-request',true);
        /*readVideos.setRequestHeader('Content-Type', 'text/json');
        readVideos.overrideMimeType("text/plain; charset=x-user-defined");*/
        readVideos.send();


        const createForm = document.getElementById('createForm');
        createForm.addEventListener('submit', (e) => {
          console.log(createForm);
          e.preventDefault()
          xhr = new XMLHttpRequest();
          xhr.onreadystatechange = checkSaving;
          xhr.open("POST","http://localhost:7777/video-request", true);
          xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
          data = new FormData(createForm);
          postData = ''
          for (i of data.entries()){
            postData += i[0]+'='+i[1]+'&'
          }
          console.log(postData)
          xhr.send(postData)
        });
      });
    </script>
  </body>
</html>
